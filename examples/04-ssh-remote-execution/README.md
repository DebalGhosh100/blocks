# Example 4: SSH Remote Execution

## Overview
This example demonstrates how to use the `remotely.py` script to execute commands on remote servers via SSH and stream the output to local log files in real-time.

## What This Example Demonstrates
- ✅ SSH remote command execution using `remotely.py`
- ✅ Real-time log streaming to local files
- ✅ Variable interpolation for SSH credentials
- ✅ Multiple remote command executions in sequence
- ✅ Log file management and display

## Prerequisites
- Python 3.x installed
- Blocks framework installed (including `remotely.py`)
- SSH access to a remote server
- `paramiko` Python library installed (`pip install paramiko`)

## Directory Structure
```
04-ssh-remote-execution/
├── main.yaml           # Workflow with SSH remote executions
├── storage/            # Configuration files
│   └── machines.yaml   # SSH server credentials
├── logs/               # Created during execution (stores SSH logs)
└── README.md           # This file
```

## How to Run

### Step 1: Configure Your SSH Server

Edit `storage/machines.yaml` and replace with your actual server details:

```yaml
machines:
  server1:
    ip: "YOUR_SERVER_IP"          # e.g., "192.168.1.100"
    username: "YOUR_USERNAME"      # e.g., "admin"
    password: "YOUR_PASSWORD"      # e.g., "password123"
    description: "Primary server"
```

⚠️ **Security Note**: For production use, consider using SSH keys instead of passwords.

### Step 2: Run the Workflow

**Option 1: From the Example Directory**
```bash
# Navigate to this example
cd blocks/examples/04-ssh-remote-execution

# Run the workflow
python3 ../../blocks_executor.py main.yaml
```

**Option 2: Run with One-Command Execution**
```bash
# From this directory (after configuring machines.yaml)
curl -sSL https://raw.githubusercontent.com/DebalGhosh100/blocks/main/run_blocks.sh | bash
```

## Expected Output
The workflow will:
1. Create `./logs/` directory for storing SSH execution logs
2. Connect to the remote server and execute `ls -lah ~`
3. Stream output to `./logs/list_files.log`
4. Execute system information commands on remote server
5. Stream output to `./logs/system_info.log`
6. Execute network information commands
7. Stream output to `./logs/network_info.log`
8. Display all collected logs
9. Show summary of execution

## Remotely Script Syntax

### Basic Usage
```bash
python3 remotely.py <ssh_url> <password> "<command>" <log_file>
```

### Parameters
- `ssh_url`: SSH connection string (formats: `user@host`, `ssh://user@host:port`, or `host`)
- `password`: SSH password for authentication
- `command`: Linux command to execute on remote server (wrap in quotes)
- `log_file`: Local file path where logs will be streamed (relative or absolute)

### Examples

**Simple command:**
```bash
python3 remotely.py admin@192.168.1.100 mypass "ls -la" ./logs/output.log
```

**Complex command with pipes:**
```bash
python3 remotely.py admin@192.168.1.100 mypass "df -h && free -m" ./logs/system.log
```

**Custom SSH port:**
```bash
python3 remotely.py ssh://admin@192.168.1.100:2222 mypass "uptime" ./logs/uptime.log
```

## Workflow Breakdown

### Block 1: Prepare Logs Directory
```yaml
- name: "Prepare Logs Directory"
  description: "Create directory for SSH execution logs"
  run: "mkdir -p ./logs && echo 'Logs directory ready'"
```
Creates the logs directory if it doesn't exist.

### Block 2: Execute Remote Command - List Files
```yaml
- name: "Execute Remote Command - List Files"
  description: "List files in remote server home directory"
  run: |
    python3 ../../remotely.py \
      ${machines.server1.username}@${machines.server1.ip} \
      ${machines.server1.password} \
      "ls -lah ~" \
      ./logs/list_files.log
```

**What happens:**
1. Connects to `${machines.server1.ip}` as `${machines.server1.username}`
2. Authenticates with `${machines.server1.password}`
3. Executes `ls -lah ~` on the remote server
4. Streams output in real-time to `./logs/list_files.log`
5. Includes execution metadata (timestamp, exit status)

### Block 3: Execute Remote Command - System Info
```yaml
- name: "Execute Remote Command - System Info"
  run: |
    python3 ../../remotely.py \
      ${machines.server1.username}@${machines.server1.ip} \
      ${machines.server1.password} \
      "uname -a && df -h && free -h" \
      ./logs/system_info.log
```
Executes multiple commands chained with `&&` and captures all output.

### Block 5: Display Log Results
```yaml
- name: "Display Log Results"
  run: |
    echo "--- List Files Log ---"
    cat ./logs/list_files.log
    echo "--- System Info Log ---"
    cat ./logs/system_info.log
```
Displays the contents of all collected logs.

## Log File Format

Each log file generated by `remotely.py` includes:

```
=== SSH Log Stream Started ===
Timestamp: 2024-11-09T10:30:45.123456
Host: admin@192.168.1.100
Command: ls -lah ~
==================================================

[Command output appears here in real-time]

==================================================
Command completed with exit status: 0
Timestamp: 2024-11-09T10:30:47.654321
=== SSH Log Stream Ended ===
```

## Real-Time Log Streaming

The `remotely.py` script streams output **in real-time**, which means:

✅ **Progress bars** are captured (e.g., `wget`, `dd`, `rsync`)
✅ **Long-running commands** show output as they execute
✅ **Immediate feedback** - no waiting for command completion
✅ **Binary-safe** - handles all output types correctly

Example with progress bar:
```yaml
- run: |
    python3 remotely.py user@host pass \
      "wget http://example.com/large-file.iso" \
      ./logs/download.log
```

The log file will capture the wget progress bar updates!

## Variable Interpolation with SSH

Combine variable interpolation with SSH for powerful workflows:

**storage/machines.yaml:**
```yaml
machines:
  web_servers:
    server1:
      ip: "10.0.1.10"
      username: "deploy"
      password: "deploy123"
    server2:
      ip: "10.0.1.11"
      username: "deploy"
      password: "deploy123"

  databases:
    primary:
      ip: "10.0.2.10"
      username: "dbadmin"
      password: "dbpass"
```

**Workflow:**
```yaml
blocks:
  - run: |
      python3 remotely.py \
        ${machines.web_servers.server1.username}@${machines.web_servers.server1.ip} \
        ${machines.web_servers.server1.password} \
        "systemctl status nginx" \
        ./logs/web1_nginx.log
```

## Use Cases

### 1. Health Checks
```yaml
- run: |
    python3 remotely.py ${machines.server.username}@${machines.server.ip} \
      ${machines.server.password} \
      "systemctl status app && curl -f http://localhost:8080/health" \
      ./logs/health_check.log
```

### 2. Log Collection
```yaml
- run: |
    python3 remotely.py ${machines.server.username}@${machines.server.ip} \
      ${machines.server.password} \
      "tail -n 100 /var/log/app/error.log" \
      ./logs/app_errors.log
```

### 3. File Downloads (with progress)
```yaml
- run: |
    python3 remotely.py ${machines.server.username}@${machines.server.ip} \
      ${machines.server.password} \
      "wget http://updates.example.com/package.tar.gz" \
      ./logs/download.log
```

### 4. Database Backups
```yaml
- run: |
    python3 remotely.py ${machines.db.username}@${machines.db.ip} \
      ${machines.db.password} \
      "pg_dump mydb > /backups/mydb_$(date +%Y%m%d).sql" \
      ./logs/backup.log
```

## Troubleshooting

### Issue: Connection Refused
**Problem:** Cannot connect to SSH server

**Solutions:**
- Verify IP address is correct
- Check that SSH service is running: `sudo systemctl status sshd`
- Verify network connectivity: `ping <server-ip>`
- Check firewall rules allow port 22

### Issue: Authentication Failed
**Problem:** Password authentication fails

**Solutions:**
- Double-check username and password in `machines.yaml`
- Verify the user account exists on remote server
- Check that password authentication is enabled in `/etc/ssh/sshd_config`

### Issue: Command Not Found
**Problem:** Remote command fails with "command not found"

**Solutions:**
- Use full paths: `/usr/bin/command` instead of `command`
- Check that the command is installed on the remote server
- Verify PATH is set correctly for the remote user

### Issue: Permission Denied
**Problem:** Command fails due to insufficient permissions

**Solutions:**
- Use `sudo` for privileged commands: `"sudo systemctl restart nginx"`
- Ensure remote user has necessary permissions
- Check file/directory permissions on remote server

## Security Considerations

⚠️ **Warning**: This example stores passwords in plain text for simplicity.

**For production use:**
1. **Use SSH Keys** instead of passwords
2. **Environment Variables** for sensitive data
3. **Secret Management Tools** (HashiCorp Vault, AWS Secrets Manager)
4. **Encrypted Configuration Files**
5. **Principle of Least Privilege** - use accounts with minimal permissions

## Key Takeaways
- `remotely.py` enables SSH command execution from workflows
- Output is streamed in real-time to local log files
- Progress bars and long-running commands are fully supported
- Combine with variable interpolation for flexible configurations
- Log files include metadata and execution status

## Next Steps
- Configure your actual SSH servers in `machines.yaml`
- Try executing different commands on your servers
- Explore the next example: **05-multi-server-deployment**
